<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Accelerometer Javascript Test</title>
<meta name="viewport" content="width=device-width,user-scalable=yes" />
<style>
body {
    font-family: helvetica, arial, sans serif;
}
#sphere {
    position: absolute;
    width: 50px;
    height: 50px;
    border-radius: 50px;
    -webkit-radius: 50px;
    background-color: blue;
}
</style>
</head>

<body>
<div id="content">
    <h1>Accelerometer Javascript Test</h1>
    <div id="sphere"></div>
<ul>
    <li>acceleration x: <span id="accelerationX"></span>g</li>
    <li>acceleration y: <span id="accelerationY"></span>g</li>
    <li>acceleration z: <span id="accelerationZ"></span>g</li>
    <li>latitude: <span id="geolocation_lat"></span></li>
    <li>longitude: <span id="geolocation_lon"></span></li>

    <li>delta latitude: <span id="d_geolocation_lat"></span></li>
    <li>delta longitude: <span id="d_geolocation_lon"></span></li>

    <li>acceleration with gravity: <span id="accelerationWithGravity"></span></li>
    <li>acceleration: <span id="acceleration"></span></li>
    <li>velocity: <span id="velocity"></span></li>
    <li>position: <span id="position"></span></li>

    <li>rotation alpha: <span id="rotationAlpha"></span>degree</li>
    <li>rotation beta: <span id="rotationBeta"></span>degree</li>
    <li>rotation gamma: <span id="rotationGamma"></span>degree</li>
</ul>

test: <span id="test"></span>
</div>
<script type="text/javascript">
//geo
var browserSupportFlag = 'rad';
var mylocation = 'okay';

var prev_lat = 0;
var prev_lon = 0;
var rmult = 1000000;

console.log("ok");

function doGeo(){
    if(navigator.geolocation) {
        browserSupportFlag = true;
        navigator.geolocation.watchPosition(function(position) {
            console.log("called");
          document.getElementById("geolocation_lat").innerHTML += "\n" + position.coords.latitude;
          document.getElementById("geolocation_lon").innerHTML += "\n" + position.coords.longitude;

          delta_lat = Math.abs(prev_lat - position.coords.latitude);
          delta_lon = Math.abs(prev_lon - position.coords.longitude);

          document.getElementById("d_geolocation_lat").innerHTML += "\n" + Math.round(rmult*delta_lat)/rmult;
          document.getElementById("d_geolocation_lon").innerHTML += "\n" + Math.round(rmult*delta_lon)/rmult;

          prev_lat = position.coords.latitude;
          prev_lon = position.coords.longitude;

        }, function() {
          document.getElementById("geolocation_lat").innerHTML += "\n" + 'missed';
           document.getElementById("geolocation_lon").innerHTML += "\n" + 'missed';
        });
      }
      else {
        document.getElementById("geolocation_lat").innerHTML = 'noooooope';
        document.getElementById("geolocation_lon").innerHTML = 'noooooope';
      }
  }

function showLocation(){
    console.log("okay!");
    console.log(position);
    document.getElementById("geolocation_lat").innerHTML = position.join(', ');
    // for (var i=0; i<position.length; i++){
    //     document.getElementById("geolocation_lat").innerHTML += position[i];
    // }
}

function errorHandler(){
    console.log("error :( ");
}


function getLocationUpdate(){

   if(navigator.geolocation){
      // timeout at 60000 milliseconds (60 seconds)
      var options = {timeout:60000};
      geoLoc = navigator.geolocation;
      watchID = geoLoc.getCurrentPosition(showLocation,
                                     errorHandler,
                                     options);
   }else{
      alert("Sorry, browser does not support geolocation!");
   }
}
getLocationUpdate();

// var interval = setInterval(function(){
//     doGeo();
// }, 3000);

//endgeo

var x = 0, y = 0,
    vx = 0, vy = 0,
    ax = 0, ay = 0;

var sphere = document.getElementById("sphere");

if (window.DeviceMotionEvent != undefined) {
    window.ondevicemotion = function(e) {
        ax = event.accelerationIncludingGravity.x * 5;
        ay = event.accelerationIncludingGravity.y * 5;
        document.getElementById("accelerationX").innerHTML = e.accelerationIncludingGravity.x;
        document.getElementById("accelerationY").innerHTML = e.accelerationIncludingGravity.y;
        document.getElementById("accelerationZ").innerHTML = e.accelerationIncludingGravity.z;

        if ( e.rotationRate ) {
            document.getElementById("rotationAlpha").innerHTML = e.rotationRate.alpha;
            document.getElementById("rotationBeta").innerHTML = e.rotationRate.beta;
            document.getElementById("rotationGamma").innerHTML = e.rotationRate.gamma;
        }
    }

    setInterval( function() {
        var landscapeOrientation = window.innerWidth/window.innerHeight > 1;
        if ( landscapeOrientation) {
            vx = vx + ay;
            vy = vy + ax;
        } else {
            vy = vy - ay;
            vx = vx + ax;
        }
        vx = vx * 0.98;
        vy = vy * 0.98;
        y = parseInt(y + vy / 50);
        x = parseInt(x + vx / 50);

        boundingBoxCheck();

        sphere.style.top = y + "px";
        sphere.style.left = x + "px";

    }, 25);
}


function boundingBoxCheck(){
    if (x<0) { x = 0; vx = -vx; }
    if (y<0) { y = 0; vy = -vy; }
    if (x>document.documentElement.clientWidth-20) { x = document.documentElement.clientWidth-20; vx = -vx; }
    if (y>document.documentElement.clientHeight-20) { y = document.documentElement.clientHeight-20; vy = -vy; }

}

</script>

</body>
</html>
